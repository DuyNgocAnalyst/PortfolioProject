/* DLL_PRACTICES */
/* Tạo các bảng dữ liệu */

Create table KHACHHANG
(
MAKHACHHANG NVARCHAR(50) NOT NULL
CONSTRAINT pk_KHACHHANG PRIMARY KEY(MAKHACHHANG),
TENCONGTY NVARCHAR(50) NOT NULL,
TENGIAODICH NVARCHAR(50) NOT NULL,
DIACHI NVARCHAR(50) NULL,
EMAIL NVARCHAR(50) NULL,
DIENTHOAI NVARCHAR(50) NULL,
FAX NVARCHAR(50) NULL
)



CREATE TABLE DONDATHANG
(
SOHOADON INT NOT NULL,
MAKHACHHANG NVARCHAR(50) NULL,
MANHANVIEN NVARCHAR(50) NULL,
NGAYDATHANG SMALLDATETIME NULL,
NGAYGIAOHANG SMALLDATETIME NULL,
NGAYCHUYENHANG SMALLDATETIME NULL,
NOIGIAOHANG NVARCHAR(50) NULL,
CONSTRAINT pk_DONDATHANG_SOHOADON PRIMARY KEY(SOHOADON)
)
	
  
  
CREATE TABLE NHANVIEN
(
MANHANVIEN NVARCHAR(50) NOT NULL,
HO NVARCHAR(50) NOT NULL,
TEN NVARCHAR(50) NOT NULL,
NGAYSINH SMALLDATETIME NULL,
NGAYLAMVIEC SMALLDATETIME NULL,
DIACHI NVARCHAR NULL,
DIENTHOAI NVARCHAR NULL,
LUONGCOBAN MONEY NULL,
PHUCAP MONEY NULL,
CONSTRAINT pk_NHANVIEN_MANHANVIEN PRIMARY KEY (MANHANVIEN)
)



CREATE TABLE NHACUNGCAP
(
MACONGTY NVARCHAR(50) NOT NULL,
TENCONGTY NVARCHAR(50) NOT NULL,
TENGIAODICH NVARCHAR(50) NULL,
DIACHI NVARCHAR(60) NULL,
DIENTHOAI NVARCHAR(50) NULL,
FAX NVARCHAR(50) NULL,
EMAIL NVARCHAR(50) NULL,
CONSTRAINT pk_NHACUNGCAP_MACONGTY PRIMARY KEY (MACONGTY)
)



CREATE TABLE CHITIETDATHANG
(
SOHOADON INT NOT NULL,
MAHANG NVARCHAR(50) NOT NULL,
GIABAN MONEY NOT NULL,
SOLUONG SMALLINT NOT NULL,
MUCGIAMGIA REAL NOT NULL,
CONSTRAINT pk_CHITIETDATHANG PRIMARY KEY(SOHOADON, MAHANG)
)



CREATE TABLE MATHANG
(
MAHANG NVARCHAR(50) NOT NULL,
TENHANG NVARCHAR(50) NOT NULL,
MACONGTY NVARCHAR(50) NULL,
MALOAIHANG NVARCHAR(50) NULL,
SOLUONG SMALLINT NULL,
DONVITINH MONEY NULL,
GIAHANG MONEY NULL,
CONSTRAINT pk_MATHANG PRIMARY KEY(MAHANG)
)



CREATE TABLE LOAIHANG
(
MALOAIHANG INT NOT NULL,
TENLOAIHANG NVARCHAR(50) NOT NULL,
CONSTRAINT pk_LOAIHANG PRIMARY KEY(MALOAIHANG)
)



/* Thiết lập mối quan hệ giữa các bảng */

ALTER TABLE DONDATHANG
ADD
	CONSTRAINT FK_DONDATHANG_KHACHHANG
	FOREIGN KEY(MAKHACHHANG)
	REFERENCES KHACHHANG(MAKHACHHANG)
	ON DELETE CASCADE 
	ON UPDATE CASCADE,

	CONSTRAINT FK_DONDATHANG_NHANVIEN
	FOREIGN KEY (MANHANVIEN)
	REFERENCES NHANVIEN(MANHANVIEN)
	ON DELETE CASCADE
	ON UPDATE CASCADE



ALTER TABLE CHITIETDATHANG
ADD
	CONSTRAINT FK_CHITIETDATHANG_MATHANG
	FOREIGN KEY (MAHANG)
	REFERENCES MATHANG(MAHANG)
	ON DELETE CASCADE
	ON UPDATE CASCADE,

	CONSTRAINT FK_CHITIETDATHANG_DONDATHANG
	FOREIGN KEY (SOHOADON)
	REFERENCES DONDATHANG(SOHOADON)
	ON DELETE CASCADE
	ON UPDATE CASCADE



ALTER TABLE MATHANG
ADD
	CONSTRAINT FK_MATHANG_NHACUNGCAP
	FOREIGN KEY (MACONGTY)
	REFERENCES NHACUNGCAP(MACONGTY)
	ON DELETE CASCADE
	ON UPDATE CASCADE,

	CONSTRAINT FK_MATHANG_LOAIHANG
	FOREIGN KEY (MALOAIHANG)
	REFERENCES LOAIHANG(MALOAIHANG)
	ON DELETE CASCADE
	ON UPDATE CASCADE
  


/* Bổ sung ràng buộc thiết lập giá trị mặc định bằng 1 cho cột COLUONG và bằng 0 cho cột MUCGIAMGIA trong bảng CHITIETDATHANG */

ALTER TABLE CHITIETDATHANG
ADD
	CONSTRAINT DF_CHITIETDATHANG_SOLUONG
	DEFAULT (1) FOR SOLUONG,
	CONSTRAINT DF_CHITIETDATHANG_MUCGIAMGIA
	DEFAULT (0) FOR MUCGIAMGIA


/* Bổ sung cho bảng DONDATHANG ràng buộc kiểm tra ngày giao hàng
và ngày chuyển hàng phải sau hoặc bằng với ngày đặt hàng */


ALTER TABLE DONDATHANG
ADD
	CONSTRAINT CHK_DONDATHANG_NGAY
	CHECK ([NGAYGIAOHANG]>=[NGAYDATHANG] AND [NGAYCHUYENHANG]>=[NGAYDATHANG])


 /* Bổ sung ràng buộc cho bảng NHANVIEN để đảm bảo rằng 
 một nhân viên chỉ có thể làm việc trong công ty khi đủ 18 tuổi và không quá 60 tuổi */
 
 
 ALTER TABLE [dbo].[NHANVIEN]
ADD
	CONSTRAINT CHK_TUOI
	CHECK (DATEDIFF(YY, [NGAYSINH], [NGAYLAMVIEC]) BETWEEN 18 AND 60)
  
  
  
/* DML_PRACTICES */
/* Sử dụng câu lệnh SELECT */

-- 1. Danh sách các đối tác cung cấp hàng cho công ty
SELECT MACONGTY, TENCONGTY, TENGIAODICH
FROM NHACUNGCAP

-- 2. Mã hàng, tên hàng và số lượng  các mặt hàng hiện có trong công ty
SELECT MAHANG, TENHANG, SOLUONG
FROM MATHANG

-- 3. Họ tên, địa chỉ và năm bắt đầu làm việc của các nhân viên trong công ty
SELECT HO, TEN, DIACHI, YEAR(NGAYLAMVIEC) AS NAMLAMVIEC
FROM NHANVIEN

-- 4. Địa chỉ và điện thoại của nhà cung cấp có tên giao dịch VINAMILK
SELECT DIACHI, DIENTHOAI
FROM NHACUNGCAP
WHERE [TENCONGTY] = 'VINAMILK'

-- 5. Mã và tên của các mặt hàng có giá trị lớn hơn 100.000k và số lượng hiện có ít hơn 50.
SELECT MAHANG, TENHANG
FROM MATHANG
WHERE [SOLUONG] <= 50 AND [GIAHANG] >= 100000

-- 6. Mỗi mặt hàng trong công ty do ai cung cấp
SELECT MAHANG, TENHANG, NHACUNGCAP.MACONGTY, TENCONGTY, TENGIAODICH
FROM MATHANG LEFT OUTER JOIN NHACUNGCAP
ON MATHANG.MACONGTY = NHACUNGCAP.MACONGTY

-- 7. Công ty VIETTIEN đã cung cấp những mặt hàng nào
SELECT MAHANG, TENHANG, TENCONGTY
FROM MATHANG INNER JOIN NHACUNGCAP
ON MATHANG.MACONGTY = NHACUNGCAP.MACONGTY
WHERE TENCONGTY = 'VIETTIEN'

-- 8. Loại hàng 'thực phẩm' do những công ty nào cung cấp và địa chỉ của các công ty đó 
SELECT TENLOAIHANG, TENCONGTY, DIACHI
FROM (LOAIHANG INNER JOIN MATHANG
ON LOAIHANG.MALOAIHANG = MATHANG.MALOAIHANG) 
INNER JOIN NHACUNGCAP 
ON MATHANG.MACONGTY = NHACUNGCAP.MACONGTY
WHERE TENLOAIHANG = 'TH?C PH?M'

-- 9. Những khách hàng nào (tên giao dịch) đã đặt mua mặt hàng 'Sữa hộp XYZ' của công ty
SELECT DISTINCT TENGIAODICH, DONDATHANG.MAKHACHHANG
FROM ((MATHANG INNER JOIN CHITIETDATHANG ON MATHANG.MAHANG = CHITIETDATHANG.GIABAN) 
INNER JOIN DONDATHANG ON CHITIETDATHANG.SOHOADON = DONDATHANG.SOHOADON) 
INNER JOIN KHACHHANG ON DONDATHANG.[MAKHACHHANG] = KHACHHANG.[MAKHACHHANG]
WHERE MATHANG.TENHANG = 'S?A H?P XYZ'


-- 10. Đơn đặt hàng số 1 do ai đặt và do nhân viên nào lập, thời gian và địa điểm giao hàng là ở đâu
SELECT SOHOADON, DONDATHANG.MANHANVIEN, HO, TEN, DIACHI, NGAYGIAOHANG
FROM DONDATHANG INNER JOIN NHANVIEN ON DONDATHANG.MANHANVIEN = NHANVIEN.MANHANVIEN
WHERE SOHOADON = 1

-- 11. Hãy cho biết số tiền lương mà công ty phải trả cho mỗi nhân viên là bao nhiêu (lương = lương cơ bản + phụ cấp)
SELECT NHANVIEN.MANHANVIEN, HO, TEN, LUONGCOBAN + CASE
											WHEN PHUCAP IS NULL THEN 0
											ELSE PHUCAP
										END AS LUONG
FROM [dbo].[NHANVIEN]

-- 12. Đơn đặt hàng số 3 đặt mua những mặt hàng nào và số tiền mà KH phải trả cho mỗi mặt hàng là bao nhiêu (số tiền phải trả được tính theo công thức SOLUONG * GIABAN - SOLUONG*GIABAN*MUCGIAMGIA/100)
SELECT a.MAHANG, TENHANG, a.SOLUONG*GIABAN*(1-MUCGIAMGIA/100) AS SOTIEN
FROM [dbo].[CHITIETDATHANG] AS a INNER JOIN [dbo].[MATHANG] AS b ON a.MAHANG = B.MAHANG

-- 13. Những khách hàng nào lại chính là đối tác cung cấp hàng của công ty (cùng tên giao dịch)
SELECT KHACHHANG.MAKHACHHANG, KHACHHANG.TENCONGTY, KHACHHANG.TENGIAODICH
FROM KHACHHANG INNER JOIN NHACUNGCAP ON KHACHHANG.TENGIAODICH = NHACUNGCAP.TENGIAODICH 

-- 14. Trong công ty, những nhân viên cùng ngày sinh
SELECT a.HO,a.TEN, b.HO, b.TEN, b.NGAYSINH
FROM NHANVIEN a INNER JOIN NHANVIEN b ON a.NGAYSINH = b.NGAYSINH AND a.MANHANVIEN <> b.MANHANVIEN

-- 15.  Những đơn đặt hàng nào yêu cầu giao hàng ngay tại công ty đặt hàng và những đơn đó của công ty nào

SELECT TENGIAODICH, TENCONGTY
FROM DONDATHANG INNER JOIN KHACHHANG ON DONDATHANG.NOIGIAOHANG = KHACHHANG.DIACHI

-- 16. Cho biết tên công ty, tên giao dịch, địa chỉ và điện thoại của các KH và các nhà cung cấp hàng cho công ty
SELECT TENCONGTY, TENGIAODICH, DIACHI, DIENTHOAI, TENCONGTY
FROM KHACHHANG
UNION ALL
SELECT TENCONGTY, TENGIAODICH, DIACHI, DIENTHOAI, TENCONGTY
FROM NHACUNGCAP

-- 17. Những mặt hàng chưa từng được KH đặt mua
SELECT MAHANG, TENHANG
FROM MATHANG
WHERE NOT EXISTS (SELECT MATHANG.MACONGTY FROM MATHANG INNER JOIN CHITIETDATHANG ON MATHANG.MAHANG = CHITIETDATHANG.MAHANG)

-- 18. Những nhân viên chưa từng lập bất kỳ một hóa đơn đặt hàng nào
SELECT NHANVIEN.MANHANVIEN, NHANVIEN.HO, NHANVIEN.TEN
FROM NHANVIEN
WHERE NHANVIEN.MANHANVIEN NOT EXISTS (SELECT NHANVIEN.MANHANVIEN FROM NHANVIEN INNER JOIN DONDATHANG ON NHANVIEN.MANHANVIEN = DONDATHANG.MANHANVIEN)

-- 19. Những nhân viên có lương cơ bản cao nhất
SELECT NHANVIEN.HO, NHANVIEN.TEN, NHANVIEN.LUONGCOBAN
FROM NHANVIEN
WHERE LUONGCOBAN = (SELECT MAX(LUONGCOBAN) FROM NHANVIEN)

-- 20. Tổng số tiền mà KH phải trả cho mỗi đơn đặt hàng là bao nhiêu
SELECT DONDATHANG.MAKHACHHANG, CHITIETDATHANG.GIABAN*CHITIETDATHANG.SOLUONG * (1-MUCGIAMGIA/100) AS TONGTIEN
FROM DONDATHANG INNER JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
SELECT DONDATHANG.SOHOADON, DONDATHANG.MAKHACHHANG, TENCONGTY, TENGIAODICH, SUM(SOLUONG*GIABAN -SOLUONG*GIABAN*MUCGIAMGIA/100)
FROM (KHACHHANG INNER JOIN DONDATHANG ON KHACHHANG.MAKHACHHANG = DONDATHANG.MAKHACHHANG) 
INNER JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
	GROUP BY DONDATHANG.MAKHACHHANG, TENCONGTY, TENGIAODICH, DONDATHANG.SOHOADON

-- 21. Năm 2003, những mặt hàng nào chỉ được đặt mua đúng 1 lần
SELECT CHITIETDATHANG.MAHANG, MATHANG.TENHANG
FROM (DONDATHANG INNER JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON) INNER JOIN MATHANG ON CHITIETDATHANG.MAHANG = MATHANG.MAHANG
WHERE YEAR(NGAYDATHANG) = 2003
GROUP BY CHITIETDATHANG.MAHANG, MATHANG.TENHANG
HAVING COUNT (CHITIETDATHANG.MAHANG) = 1

-- 22. Hãy cho biết mỗi một khách hàng đã phải bỏ ra bao nhiêu tiền để đặt mua hàng của công ty
Select KHACHHANG.MAKHACHHANG, TENCONGTY, SUM(CHITIETDATHANG.GIABAN * CHITIETDATHANG.SOLUONG * (1- CHITIETDATHANG.MUCGIAMGIA/100)) AS TONGTIEN
FROM (KHACHHANG INNER JOIN DONDATHANG ON KHACHHANG.MAKHACHHANG = DONDATHANG.MAKHACHHANG) 
INNER JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
GROUP BY KHACHHANG.MAKHACHHANG, TENCONGTY, TENGIAODICH

-- 23. Mỗi 1 nhân viên của công ty đã lập bao nhiêu đơn đặt hàng (nếu nhân viên chưa hề lập 1 hóa đơn nào thì cho kết quả là 0)
SELECT NHANVIEN.MANHANVIEN, HO, TEN, COUNT(SOHOADON)
FROM NHANVIEN LEFT OUTER JOIN DONDATHANG ON NHANVIEN.MANHANVIEN = DONDATHANG.MANHANVIEN
GROUP BY NHANVIEN.MANHANVIEN, HO,TEN

-- 24. Cho biết tổng số tiền hàng mà cửa hàng thu được trong mỗi tháng của năm 2003 (thời gian được tính theo ngày đặt hàng).
SELECT MONTH(NGAYDATHANG) AS THANG, SUM(GIABAN* SOLUONG * (1 - MUCGIAMGIA/100)) AS TONGTIEN
FROM DONDATHANG INNER JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON	
WHERE YEAR(NGAYDATHANG) = 2003
GROUP BY MONTH(NGAYDATHANG)
 
 -- 25. Hãy cho biết tổng số tiền lời mà công ty thu được từ mỗi mặt hàng trong năm 2003
 SELECT MATHANG.MAHANG, TENHANG, SUM(GIABAN* CHITIETDATHANG.SOLUONG * (1 - MUCGIAMGIA/100 - MATHANG.GIAHANG)) AS TONGTIENLOI
 FROM (DONDATHANG INNER JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON) 
 INNER JOIN MATHANG ON CHITIETDATHANG.MAHANG = MATHANG.MAHANG
 WHERE YEAR(NGAYDATHANG) = 2003
 GROUP BY MATHANG.MAHANG, TENHANG

-- 26. HÃY CHO BIẾT TỔNG SỐ LƯỢNG HÀNG CỦA MỖI MẶT HÀNG MÀ CÔNG TY ĐÃ CÓ (TỔNG SỐ LƯỢNG HÀNG HIỆN CÓ VÀ ĐÃ BÁN).

 SELECT MATHANG.MAHANG, TENHANG, MATHANG.SOLUONG +
		CASE 
			WHEN SUM(CHITIETDATHANG.SOLUONG) IS NULL THEN 0
			ELSE SUM(CHITIETDATHANG.SOLUONG)
		END AS TONGSOLUONG
 FROM MATHANG LEFT OUTER JOIN CHITIETDATHANG
 ON MATHANG.MAHANG = CHITIETDATHANG.MAHANG
 GROUP BY MATHANG.MAHANG, TENHANG, MATHANG.SOLUONG

 -- 27. NHÂN VIÊN NÀO BÁN ĐƯỢC SỐ LƯỢNG HÀNG NHIỀU NHẤT VÀ SỐ LƯỢNG BÁN ĐƯỢC CỦA NHÂN VIÊN NÀY LÀ BAO NHIÊU?
 SELECT NHANVIEN.MANHANVIEN, HO, TEN, SUM(CHITIETDATHANG.SOLUONG) AS SOLUONGBANDUOC
 FROM (NHANVIEN INNER JOIN DONDATHANG ON NHANVIEN.MANHANVIEN = DONDATHANG.MANHANVIEN) 
 INNER JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
 GROUP BY NHANVIEN.MANHANVIEN, HO, TEN
 HAVING SUM(CHITIETDATHANG.SOLUONG) >= ALL(SELECT SUM(CHITIETDATHANG.SOLUONG)
											FROM (NHANVIEN INNER JOIN DONDATHANG ON NHANVIEN.MANHANVIEN = DONDATHANG.MANHANVIEN) 
											INNER JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
											GROUP BY NHANVIEN.MANHANVIEN, HO, TEN)

-- 28. ĐƠN ĐẶT HÀNG NÀO CÓ SỐ LƯỢNG HÀNG ĐƯỢC ĐẶT MUA ÍT NHẤT
SELECT DONDATHANG.SOHOADON, SUM(CHITIETDATHANG.SOLUONG)
FROM DONDATHANG INNER JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
GROUP BY DONDATHANG.SOHOADON
HAVING SUM(CHITIETDATHANG.SOLUONG) <= ALL( SELECT  SUM(CHITIETDATHANG.SOLUONG)
FROM DONDATHANG INNER JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
GROUP BY DONDATHANG.SOHOADON)

-- 29. Số tiền nhiều nhất mà mỗi khách hàng từng bỏ ra để đặt hàng trong các đơn đặt hàng là bao nhiêu.
Có nghĩa là chỉ cần tìm max của sum đơn hàng. 
SELECT top 1 SUM(GIABAN* CHITIETDATHANG.SOLUONG * (1 - MUCGIAMGIA/100)) 
FROM DONDATHANG INNER JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
ORDER BY 1 DESC


-- 30. MỖI ĐƠN ĐẶT HÀNG ĐẶT MUA NHỮNG MẶT HÀNG NÀO VÀ TỔNG SỐ TIỀN MỖI ĐƠN ĐẶT HÀNG PHẢI TRẢ LÀ BAO NHIÊU.

SELECT a.SOHOADON, b.MAHANG, TENHANG, b.SOLUONG*GIABAN - b.SOLUONG*GIABAN*MUCGIAMGIA/100
FROM (DONDATHANG AS a INNER JOIN CHITIETDATHANG AS b ON a.SOHOADON = b.SOHOADON)
INNER JOIN MATHANG AS c ON b.SOHOADON = c.SOHOADON
ORDER BY a.SOHOADON
COMPUTE SUM(b.SOLUONG*GIABAN - b.SOLUONG*GIABAN*MUCGIAMGIA/100) BY a.SOHOADON

-- 31. Hãy cho biết mỗi 1 loại hàng bao gồm những mặt hàng nào, tổng số lượng hàng của mỗi loại và tổng số lượng của tất cả các mặt hàng hiện có trong công ty là bao nhiêu

SELECT LOAIHANG.MALOAIHANG, TENLOAIHANG, MAHANG, TENHANG, SOLUONG
FROM LOAIHANG INNER JOIN MATHANG
ON LOAIHANG.MALOAIHANG = MATHANG.MALOAIHANG
ORDER BY LOAIHANG.MALOAIHANG
COMPUTE SUM(SOLUONG) BY LOAIHANG.MALOAIHANG
COMPUTE SUM(SOLUONG)

-- 32. Thống kê xem trong năm 2003, mỗi một mặt hàng trong mỗi tháng và trong cả năm bán được với số lượng bao nhiêu.

SELECT b.MAHANG, [TENHANG], 
SUM(CASE MONTH(NGAYDATHANG) WHEN 1 THEN b.SOLUONG
	ELSE O END) AS THANG1,
SUM(CASE MONTH(NGAYDATHANG) WHEN 2 THEN b.SOLUONG
	ELSE O END) AS THANG2,
SUM(CASE MONTH(NGAYDATHANG) WHEN 3 THEN b.SOLUONG
	ELSE O END) AS THANG3,
SUM(CASE MONTH(NGAYDATHANG) WHEN 4 THEN b.SOLUONG
	ELSE O END) AS THANG4,
SUM(CASE MONTH(NGAYDATHANG) WHEN 5 THEN b.SOLUONG
	ELSE O END) AS THANG5,
SUM(CASE MONTH(NGAYDATHANG) WHEN 6 THEN b.SOLUONG
	ELSE O END) AS THANG6,
SUM(CASE MONTH(NGAYDATHANG) WHEN 7 THEN b.SOLUONG
	ELSE O END) AS THANG7,
SUM(CASE MONTH(NGAYDATHANG) WHEN 8 THEN b.SOLUONG
	ELSE O END) AS THANG8,
SUM(CASE MONTH(NGAYDATHANG) WHEN 9 THEN b.SOLUONG
	ELSE O END) AS THANG9,
SUM(CASE MONTH(NGAYDATHANG) WHEN 10 THEN b.SOLUONG
	ELSE O END) AS THANG10,
SUM(CASE MONTH(NGAYDATHANG) WHEN 11 THEN b.SOLUONG
	ELSE O END) AS THANG11,
SUM(CASE MONTH(NGAYDATHANG) WHEN 12 THEN b.SOLUONG
	ELSE O END) AS THANG12,
SUM(b.SOLUONG) AS CANAM
FROM (DONDATHANG AS a INNER JOIN CHITIETDATHANG AS b
ON a.SOHOADON = b.SOHOADON)
WHERE YEAR(NGAYDATHANG) = 1996
GROUP BY b.MAHANG, TENHANG


/* Sử dụng câu lệnh UPDATE */

-- 33. Cập nhật lại giá trị trường NGAYCHUYENHANG của những bản ghi có NGAYCHUYENHANG chưa xác định (NULL) trong bảng DONATHANG bằng với giá trị của trường NGAYDATHANG.

UPDATE DONDATHANG
SET NGAYCHUYENHANG = NGAYDATHANG
WHERE NGAYCHUYENHANG IS NULL

-- 34. Tăng số lượng hàng của những mặt hàng do công ty  VINAMILK cung cấp lên gấp đôi

UPDATE MATHANG
SET SOLUONG = SOLUONG*2
FROM NHACUNGCAP
WHERE MATHANG.MACONGTY = NHACUNGCAP.MACONGTY AND TENCONGTY = 'vinamilk'

-- 35. Cập nhật giá trị của trường NOIGIAOHANG trong bảng DONDATHANG bằng địa chỉ của khách hàng đối với những đơn đặt hàng chưa xác định được nơi giao hàng (giá trị trường NOIGIAOHANG bằng NULL)

UPDATE DONDATHANG
SET NOIGIAOHANG = DIACHI
FROM KHACHHANG 
WHERE DONDATHANG.MAKHACHHANG = KHACHHANG.MAKHACHHANG AND NOIGIAOHANG IS NULL

-- 36. Cập nhật lại dữ liệu trong bảng KHACHHANG sao cho nếu tên công ty và tên giao dịch của KH trùng với tên công ty và tên giao dịch của một nhà cung cấp nào đó thì địa chỉ, điện thoại, fax và email phải giống nhau

UPDATE KHACHHANG
SET KHACHHANG.DIACHI = NHACUNGCAP.DIACHI
	KHACHHANG.DIENTHOAI = NHACUNGCAP.DIENTHOAI
	KHACHHANG.FAX = NHACUNGCAP.FAX
	KHACHHANG.EMAIL = NHACUNGCAP.EMAIL
FROM NHACUNGCAP
WHERE KHACHHANG.TENCONGTY = NHACUNGCAP.TENCONGTY AND
	KHACHHANG.TENGIAODICH = NHACUNGCAP.TENGIAODICH

-- 37. Tăng lương lên gấp rưỡi cho những nhân viên bán được số lượng hàng nhiều hơn 100 trong năm 2003

UPDATE NHANVIEN
SET LUONGCOBAN = LUONGCOBAN*1.5
WHERE MANHANVIEN = (SELECT MANHANVIEN
					FROM DONDATHANG INNER JOIN CHITIETDATHANG 
					ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
					GROUP BY MANHANVIEN
					HAVING SUM(SOLUONG) > 100)

-- 38. Tăng phụ cấp lên bằng 50% lương cho những nhân viên bán được hàng nhiều nhất

UPDATE NHANVIEN
SET PHUCAP = LUONGCOBAN * 0.5
WHERE MANHANVIEN IN 
(
SELECT MANHANVIEN
FROM DONDATHANG INNER JOIN CHITIETDATHANG 
ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
GROUP BY MANHANVIEN
HAVING SUM(SOLUONG) >= ALL
(SELECT SUM(SOLUONG)
FROM DONDATHANG INNER JOIN CHITIETDATHANG 
ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
GROUP BY MANHANVIEN
))


-- 39. Giảm 25% lương của những nhân viên trong năm 2003 không lập được bất kỳ đơn đặt hàng nào.

UPDATE NHANVIEN
SET LUONGCOBAN =LUONGCOBAN*0.75
FROM DONDATHANG
WHERE NHANVIEN.MANHANVIEN = DONDATHANG.MANHANVIEN AND DONDATHANG.SOHOADON IS NULL AND YEAR(NGAYDATHANG) = 2003

UPDATE NHANVIEN
SET LUONGCOBAN = LUONGCOBAN*0.75
WHERE NOT EXISTS 
(
SELECT MANHANVIEN
FROM DONDATHANG
WHERE MANHANVIEN = NHANVIEN.MANHANVIEN
)


-- 40. Giả sử trong bảng ĐONATHANG có thêm trường SOTIEN cho biết số tiền mà khách hàng phải trả trong mỗi đơn đặt hàng. Hãy tính giá trị cho trường này.

UPDATE DONDATHANG
SET SOTIEN = 
(
SELECT SUM(SOLUONG* GIABAN - SOLUONG*GIABAN*MUCGIAMGIA/100)
FROM CHITIETDATHANG
WHERE CHITIETDATHANG.SOHOADON = DONDATHANG.SOHOADON
GROUP BY SOHOADON
)

/*  Sử dụng câu lệnh DELETE  */

-- 41. Xóa khỏi NHANVIEN những nhân viên đã làm việc trong công ty quá 40 năm

DELETE FROM NHANVIEN
WHERE DATEDIFF(YY,NGAYLAMVIEC, GETDATE()) > 40

-- 42. Xóa những đơn đặt hàng trướcc năm 2000 ra khỏi cơ sở dữ liệu

DELETE FROM DONDATHANG
WHERE NGAYDATHANG < '1/1/2000'

-- 43. Xóa khỏi bảng LOAIHANG những loai hàng hiện không có mặt hàng

DELETE FROM LOAIHANG
WHERE NOT EXISTS 
(
SELECT MAHANG 
FROM MATHANG 
WHERE MATHANG.MALOAIHANG = LOAIHANG.MALOAIHANG
)

-- 44. Xóa khỏi bảng KHACHHANG những khách hàng hiện không có bất kỳ đơn đặt hàng nào cho công ty 


DELETE FROM KHACHHANG
WHERE NOT EXISTS 
(
SELECT DONDATHANG.SOHOADON
FROM DONDATHANG
WHERE KHACHHANG.MAKHACHHANG = DONDATHANG.MAKHACHHANG
)
-- 45. Xóa khỏi bảng MATHANG những mặt hàng có số lượng bằng 0 và không được đặt mua trong bất kỳ đơn đặt hàng nào.

DELETE FROM MATHANG
WHERE SOLUONG = 0 AND NOT EXISTS 
(
SELECT SOHOADON
FROM CHITIETDATHANG
WHERE CHITIETDATHANG.MAHANG = MATHANG.MAHANG
)
